<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Nexlify CRM</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
  
  <!-- Chart.js + funnel plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-funnel@4.2.5/dist/chartjs-chart-funnel.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-500: #6b7280;
      --text-main: #111827;
      --bg: #f8fafc;
      --sidebar-collapsed: 72px;
      --sidebar-expanded: 260px;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
    body { background:var(--bg); color:var(--text-main); height:100vh; overflow:hidden; }

    .top-bar {
      position:fixed; top:0; left:0; right:0; height:64px;
      background:white; border-bottom:1px solid var(--gray-200);
      padding:0 24px 0 80px; display:flex; align-items:center; justify-content:space-between;
      z-index:90;
    }
    .top-bar .logo-area { font-size:22px; font-weight:700; color:var(--primary); white-space:nowrap; }
    .btn-primary {
      background:var(--primary); color:white; border:none; padding:10px 20px;
      border-radius:10px; font-weight:600; cursor:pointer;
    }

    #menuBtn {
      position:fixed; top:12px; left:16px; width:48px; height:48px;
      background:white; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.08);
      display:flex; align-items:center; justify-content:center; z-index:150; cursor:pointer;
    }

    #sideDrawer {
      position:fixed; top:0; left:0; width:var(--sidebar-collapsed); height:100%;
      background:white; box-shadow:4px 0 20px rgba(0,0,0,0.08);
      transition:width 0.25s ease; z-index:100; overflow:hidden;
    }
    #sideDrawer.expanded { width:var(--sidebar-expanded); }

    .main-content {
      margin-top:64px; margin-left:var(--sidebar-collapsed);
      height:calc(100vh - 64px); overflow-y:auto; padding:24px; transition:margin-left 0.25s ease;
    }
    #sideDrawer.expanded ~ .main-content { margin-left:var(--sidebar-expanded); }

    .section { display:none; }
    .section.active { display:block; }

    .filter-bar {
      background:white; border-radius:12px; padding:16px; margin-bottom:20px;
      box-shadow:0 2px 8px rgba(0,0,0,0.06); border:1px solid var(--gray-200);
      display:flex; flex-wrap:wrap; gap:12px; align-items:center;
    }
    .filter-bar input, .filter-bar select {
      padding:10px 14px; border:1px solid var(--gray-200); border-radius:8px;
      font-size:14px; min-width:180px; flex:1;
    }
    .btn-clear { background:var(--gray-200); color:var(--text-main); border:none; padding:10px 16px; border-radius:8px; cursor:pointer; }
    .result-count { font-size:14px; color:var(--gray-500); margin-left:auto; }

    .deal-card, .contact-card {
      background:white; border-radius:12px; padding:16px; margin-bottom:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.06); border:1px solid var(--gray-200); position:relative;
    }
    .ribbon {
      position:absolute; top:0; right:0; background:var(--success); color:white;
      padding:4px 12px; font-size:12px; font-weight:600; border-radius:0 12px 0 8px;
    }
    .deal-actions { margin-top:12px; display:flex; gap:8px; }
    .btn-small { padding:6px 12px; font-size:13px; border-radius:6px; cursor:pointer; }
    .btn-edit { background:#dbeafe; color:#1e40af; border:1px solid #bfdbfe; }
    .btn-delete { background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }

    .shimmer-card {
      background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);
      background-size:200% 100%; border-radius:12px; animation:shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0% {background-position:200% 0} 100% {background-position:-200% 0} }

    #savingOverlay {
      position:fixed; inset:0; background:rgba(255,255,255,0.9); backdrop-filter:blur(4px);
      z-index:2000; display:none; flex-direction:column; align-items:center; justify-content:center;
    }
    .pulse-loader {
      width:80px; height:80px; background:var(--primary); border-radius:50%;
      animation:pulse 1.6s infinite; display:flex; align-items:center; justify-content:center;
    }
    @keyframes pulse {
      0%,100% { transform:scale(0.95); box-shadow:0 0 0 0 rgba(37,99,235,0.7); }
      70%     { transform:scale(1.1);   box-shadow:0 0 0 30px rgba(37,99,235,0); }
    }

    #confirmModalOverlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:2100;
      display:none; align-items:center; justify-content:center;
    }
    .confirm-modal {
      background:white; border-radius:16px; width:90%; max-width:400px;
      padding:24px; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,0.3);
    }
    .confirm-actions { display:flex; justify-content:center; gap:16px; margin-top:24px; }

    #toast {
      position:fixed; bottom:32px; left:50%; transform:translateX(-50%);
      background:#111; color:white; padding:12px 28px; border-radius:999px;
      font-size:14px; z-index:9999; display:none;
    }

    #modalOverlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000;
      display:none; align-items:center; justify-content:center;
    }
    .modal-content {
      background:white; border-radius:16px; width:90%; max-width:480px;
      max-height:90vh; overflow-y:auto; box-shadow:0 20px 40px rgba(0,0,0,0.25);
    }
    .modal-header {
      padding:20px 24px; border-bottom:1px solid var(--gray-200);
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal-header h2 { font-size:20px; font-weight:700; margin:0; }
    .modal-close { cursor:pointer; font-size:28px; color:var(--gray-500); }
    .modal-body { padding:24px; }
    .form-group { margin-bottom:20px; }
    .form-group label { display:block; font-weight:600; margin-bottom:8px; font-size:14px; }
    .form-group input, .form-group select {
      width:100%; padding:12px 16px; border:1px solid var(--gray-200);
      border-radius:8px; font-size:16px;
    }
    .form-actions {
      padding:20px 24px; border-top:1px solid var(--gray-200);
      display:flex; justify-content:flex-end; gap:12px;
    }
    .btn-secondary {
      background:var(--gray-200); color:var(--text-main); border:none;
      padding:12px 24px; border-radius:10px; cursor:pointer; font-weight:600;
    }

    @media (max-width:991px) {
      #sideDrawer { left:calc(var(--sidebar-collapsed)*-1); width:var(--sidebar-expanded); }
      #sideDrawer.open { left:0; }
      .main-content { margin-left:0; }
    }
    @media (min-width:992px) { #menuBtn { display:none; } }
  </style>
</head>
<body>

  <div id="menuBtn" onclick="toggleDrawer()">
    <span class="material-symbols-rounded">menu</span>
  </div>

  <div id="sideDrawer" onmouseenter="expandSidebar()" onmouseleave="collapseSidebar()">
    <div class="sidebar-header">Nexlify CRM</div>
    <div class="drawer-menu">
      <a class="drawer-item" data-section="dashboard"><span class="material-symbols-rounded">dashboard</span><span class="label">Dashboard</span></a>
      <a class="drawer-item" data-section="contacts"><span class="material-symbols-rounded">people</span><span class="label">Contacts</span></a>
      <a class="drawer-item" data-section="deals"><span class="material-symbols-rounded">handshake</span><span class="label">Deals</span></a>
      <a class="drawer-item" data-section="tasks"><span class="material-symbols-rounded">task_alt</span><span class="label">Tasks</span></a>
      <a class="drawer-item" data-section="reports"><span class="material-symbols-rounded">bar_chart</span><span class="label">Reports</span></a>
      <a class="drawer-item" onclick="logout()"><span class="material-symbols-rounded">logout</span><span class="label">Log Out</span></a>
    </div>
  </div>

  <div class="top-bar">
    <div class="logo-area" id="pageTitle">Dashboard</div>
    <div>
      <button class="btn-primary" style="margin-right:8px;" onclick="openNewContactModal()">+ Contact</button>
      <button class="btn-primary" id="actionBtn" onclick="openNewDealModal()">+ Deal</button>
    </div>
  </div>

  <div class="main-content">
    <!-- Dashboard -->
    <div id="dashboard" class="section active">
      <h2>Dashboard Overview</h2>
      <div id="dashboardLoading" class="shimmer-wrapper">
        <div class="shimmer-card"></div><div class="shimmer-card"></div>
        <div class="shimmer-card"></div><div class="shimmer-card"></div>
      </div>
      <div id="dashboardContent" style="display:none;">
        <div class="dashboard-grid" id="metricCards"></div>
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:24px; margin:32px 0;">
          <div class="chart-card"><h3>Deals by Stage</h3><canvas id="dealsByStageChart" height="180"></canvas></div>
          <div class="chart-card"><h3>Win Rate</h3><canvas id="winRateChart" height="180"></canvas></div>
          <div class="chart-card" style="grid-column:1/-1;"><h3>Pipeline Funnel</h3><canvas id="funnelChart" height="160"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Contacts -->
    <div id="contacts" class="section">
      <h2>Contacts</h2>
      <div class="filter-bar">
        <input type="text" id="contactSearch" placeholder="Search name or company..." oninput="filterContacts()"/>
        <select id="contactDealFilter" onchange="filterContacts()">
          <option value="">All Contacts</option>
          <option value="withDeals">With Active Deals</option>
        </select>
        <button class="btn-clear" onclick="resetContactFilters()">Clear</button>
        <span id="contactResultCount" class="result-count">Showing all contacts</span>
      </div>
      <button class="btn-primary" style="margin:16px 0;" onclick="openNewContactModal()">+ Add Contact</button>
      <div id="contactsList"></div>
    </div>

    <!-- Deals -->
    <div id="deals" class="section">
      <h2>Deals</h2>
      <div class="filter-bar">
        <input type="text" id="dealSearch" placeholder="Search company or contact..." oninput="filterDeals()"/>
        <select id="dealStageFilter" onchange="filterDeals()">
          <option value="">All Stages</option>
          <option value="lead">Lead</option>
          <option value="contacted">Contacted</option>
          <option value="qualified">Qualified</option>
          <option value="proposal">Proposal</option>
          <option value="negotiation">Negotiation</option>
          <option value="won">Won</option>
          <option value="lost">Lost</option>
        </select>
        <select id="dealValueFilter" onchange="filterDeals()">
          <option value="">All Values</option>
          <option value="under100k">Under R100,000</option>
          <option value="100k-500k">R100,000 – R500,000</option>
          <option value="over500k">Over R500,000</option>
        </select>
        <button class="btn-clear" onclick="resetFilters()">Clear Filters</button>
        <span id="resultCount" class="result-count">Showing all deals</span>
      </div>
      <button class="btn-primary" style="margin:16px 0;" onclick="openNewDealModal()">+ New Deal</button>
      <div id="dealsList"></div>
    </div>

    <!-- Tasks & Reports (placeholders) -->
    <div id="tasks" class="section"><h2>Tasks</h2><div class="placeholder">Task manager coming soon...</div></div>
    <div id="reports" class="section"><h2>Reports</h2><div class="placeholder">Analytics coming soon...</div></div>
  </div>

  <!-- Saving Overlay -->
  <div id="savingOverlay">
    <div class="pulse-loader"><span class="material-symbols-rounded">sync</span></div>
    <h2>Saving...</h2>
    <p>Please wait</p>
  </div>

  <!-- Deal Modal -->
  <div id="dealModalOverlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="dealModalTitle">New Deal</h2>
        <span class="modal-close material-symbols-rounded" onclick="closeDealModal()">close</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="dealContactSelect">Contact *</label>
          <select id="dealContactSelect" required>
            <option value="">-- Select or type new --</option>
          </select>
          <input type="text" id="dealNewContactName" placeholder="Or type new contact name..." style="margin-top:8px;display:none;width:100%;"/>
        </div>
        <div class="form-group">
          <label for="dealCompany">Company</label>
          <input type="text" id="dealCompany" placeholder="e.g. Acme Corp"/>
        </div>
        <div class="form-group">
          <label for="dealValue">Value (R)</label>
          <input type="number" id="dealValue" min="0" value="0"/>
        </div>
        <div class="form-group">
          <label for="dealStage">Stage</label>
          <select id="dealStage">
            <option value="lead">Lead</option>
            <option value="contacted">Contacted</option>
            <option value="qualified">Qualified</option>
            <option value="proposal" selected>Proposal</option>
            <option value="negotiation">Negotiation</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dealClose">Expected Close Date</label>
          <input type="date" id="dealClose"/>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-secondary" onclick="closeDealModal()">Cancel</button>
        <button class="btn-primary" onclick="saveDeal()">Save</button>
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div id="contactModalOverlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="contactModalTitle">New Contact</h2>
        <span class="modal-close material-symbols-rounded" onclick="closeContactModal()">close</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="contactName">Full Name *</label>
          <input type="text" id="contactName" required placeholder="John Smith"/>
        </div>
        <div class="form-group">
          <label for="contactCompany">Company</label>
          <input type="text" id="contactCompany" placeholder="Acme Corp"/>
        </div>
        <div class="form-group">
          <label for="contactEmail">Email</label>
          <input type="email" id="contactEmail" placeholder="john@acme.com"/>
        </div>
        <div class="form-group">
          <label for="contactPhone">Phone</label>
          <input type="tel" id="contactPhone" placeholder="+27 82 123 4567"/>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-secondary" onclick="closeContactModal()">Cancel</button>
        <button class="btn-primary" onclick="saveContact()">Save</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation -->
  <div id="confirmModalOverlay">
    <div class="confirm-modal">
      <h3>Delete Deal?</h3>
      <p style="margin:16px 0; color:var(--gray-500);">This action cannot be undone.</p>
      <div class="confirm-actions">
        <button class="btn-secondary" onclick="closeConfirmModal()">Cancel</button>
        <button style="background:var(--danger); color:white;" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    // ────────────────────────────────────────────────
    //  Firebase Config
    // ────────────────────────────────────────────────
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUser = null;
    let contactsData = {};
    let dealsData = {};
    let dealsListener = null;
    let contactsListener = null;
    let currentDeleteDealId = null;
    let editingDealId = null;

    let dealsByStageChart, winRateChart, funnelChart;

    // ────────────────────────────────────────────────
    //  Auth & Listeners
    // ────────────────────────────────────────────────
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        setupRealtimeListeners();
      } else {
        if (dealsListener) dealsListener.off();
        if (contactsListener) contactsListener.off();
        window.location.href = "login.html";
      }
    });

    function setupRealtimeListeners() {
      // Contacts
      contactsListener = db.ref('contacts')
        .orderByChild('owner')
        .equalTo(currentUser.uid)
        .on('value', snap => {
          contactsData = snap.val() || {};
          updateContactsTab(contactsData);
          updateContactDropdown();
          filterContacts();
        });

      // Deals
      dealsListener = db.ref('deals')
        .orderByChild('owner')
        .equalTo(currentUser.uid)
        .on('value', snap => {
          dealsData = snap.val() || {};
          updateDashboard(dealsData);
          updateDealsTab(dealsData, contactsData);
          filterDeals();
          filterContacts(); // refresh "with deals" filter
        });
    }

    // ────────────────────────────────────────────────
    //  Dashboard
    // ────────────────────────────────────────────────
    function updateDashboard(dealsObj) {
      document.getElementById('dashboardLoading').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';

      const deals = Object.values(dealsObj);
      const total = deals.length;
      const value = deals.reduce((s,d)=>s+(Number(d.value)||0),0);
      const won = deals.filter(d=>d.stage==='won').length;
      const winRate = total ? Math.round(won/total*100) : 0;
      const active = deals.filter(d=>!['won','lost'].includes(d.stage)).length;

      document.getElementById('metricCards').innerHTML = `
        <div class="metric-card"><div class="metric-label">Pipeline Value</div><div class="metric-value">R ${value.toLocaleString('en-ZA')}</div></div>
        <div class="metric-card"><div class="metric-label">Active Deals</div><div class="metric-value">${active}</div></div>
        <div class="metric-card"><div class="metric-label">Win Rate</div><div class="metric-value">${winRate}%</div></div>
        <div class="metric-card"><div class="metric-label">Total Deals</div><div class="metric-value">${total}</div></div>
      `;

      const stageOrder = ['lead','contacted','qualified','proposal','negotiation','won'];
      const labels = stageOrder.map(s => s.charAt(0).toUpperCase() + s.slice(1));
      const counts = stageOrder.map(s => deals.filter(d => d.stage === s).length);

      // Bar chart
      if (dealsByStageChart) dealsByStageChart.destroy();
      dealsByStageChart = new Chart(document.getElementById('dealsByStageChart'), {
        type: 'bar',
        data: { labels, datasets: [{ label:'Deals', data:counts, backgroundColor:'rgba(37,99,235,0.65)', borderColor:'rgba(37,99,235,1)', borderWidth:1 }] },
        options: { indexAxis:'y', responsive:true, maintainAspectRatio:false, scales:{x:{beginAtZero:true}} }
      });

      // Doughnut
      if (winRateChart) winRateChart.destroy();
      winRateChart = new Chart(document.getElementById('winRateChart'), {
        type: 'doughnut',
        data: { labels:['Won','Not Won'], datasets:[{data:[winRate,100-winRate], backgroundColor:['#10b981','#e5e7eb'], borderWidth:0}] },
        options: { responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{display:false}} },
        plugins:[{id:'centerText', afterDraw(chart){
          const {ctx, chartArea:{width,height}} = chart;
          ctx.save(); ctx.font='bold 36px Inter,sans-serif'; ctx.fillStyle='#111827';
          ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText(winRate+'%', width/2, height/2); ctx.restore();
        }}]
      });

      // Funnel
      if (funnelChart) funnelChart.destroy();
      funnelChart = new Chart(document.getElementById('funnelChart'), {
        type: 'funnel',
        data: {
          labels,
          datasets: [{
            label: 'Pipeline',
            data: counts,
            backgroundColor: ['rgba(107,114,128,0.75)','rgba(59,130,246,0.75)','rgba(139,92,246,0.75)',
                             'rgba(245,158,11,0.75)','rgba(249,115,22,0.75)','rgba(16,185,129,0.75)'],
            borderWidth: 1, borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true },
            datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: v => v > 0 ? v : '' }
          }
        }
      });
    }

    // ────────────────────────────────────────────────
    //  Contacts Tab + Filter
    // ────────────────────────────────────────────────
    function filterContacts() {
      const search = document.getElementById('contactSearch')?.value.toLowerCase().trim() || '';
      const dealFilter = document.getElementById('contactDealFilter')?.value || '';

      const container = document.getElementById('contactsList');
      container.innerHTML = '';

      const filtered = Object.entries(contactsData).filter(([cid, c]) => {
        const nameMatch = (c.name || '').toLowerCase().includes(search);
        const companyMatch = (c.company || '').toLowerCase().includes(search);
        const matchSearch = !search || nameMatch || companyMatch;

        let matchDeals = true;
        if (dealFilter === 'withDeals') {
          matchDeals = Object.values(dealsData).some(d => d.contactId === cid);
        }

        return matchSearch && matchDeals;
      });

      document.getElementById('contactResultCount').textContent = 
        `Showing ${filtered.length} of ${Object.keys(contactsData).length} contacts`;

      if (filtered.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:60px 0; color:var(--gray-500);">No matching contacts</p>';
        return;
      }

      filtered.forEach(([cid, c]) => {
        const hasDeals = Object.values(dealsData).some(d => d.contactId === cid);
        const card = document.createElement('div');
        card.className = 'contact-card';
        card.innerHTML = `
          <strong>${c.name || 'Unnamed'}</strong><br>
          <div>${c.company || '—'} • ${c.email || '—'}</div>
          ${hasDeals ? '<div class="ribbon">Active Deal</div>' : ''}
        `;
        container.appendChild(card);
      });
    }

    function resetContactFilters() {
      document.getElementById('contactSearch').value = '';
      document.getElementById('contactDealFilter').value = '';
      filterContacts();
    }

    // ────────────────────────────────────────────────
    //  Deals Tab + Filter
    // ────────────────────────────────────────────────
    function filterDeals() {
      const search = document.getElementById('dealSearch')?.value.toLowerCase().trim() || '';
      const stageFilter = document.getElementById('dealStageFilter')?.value || '';
      const valueFilter = document.getElementById('dealValueFilter')?.value || '';

      const container = document.getElementById('dealsList');
      container.innerHTML = '';

      const filtered = Object.entries(dealsData).filter(([id, d]) => {
        const company = (d.company || '').toLowerCase();
        const contact = (d.contactName || '').toLowerCase();
        const matchSearch = !search || company.includes(search) || contact.includes(search);

        const matchStage = !stageFilter || d.stage === stageFilter;

        let matchValue = true;
        if (valueFilter === 'under100k') matchValue = (d.value || 0) < 100000;
        else if (valueFilter === '100k-500k') matchValue = (d.value || 0) >= 100000 && (d.value || 0) <= 500000;
        else if (valueFilter === 'over500k') matchValue = (d.value || 0) > 500000;

        return matchSearch && matchStage && matchValue;
      });

      document.getElementById('resultCount').textContent = 
        `Showing ${filtered.length} of ${Object.keys(dealsData).length} deals`;

      if (filtered.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:60px 0; color:var(--gray-500);">No matching deals</p>';
        return;
      }

      filtered.forEach(([id, d]) => {
        const contact = contactsData[d.contactId] || {};
        const card = document.createElement('div');
        card.className = 'deal-card';
        card.innerHTML = `
          <strong>${d.company || 'Unnamed Deal'}</strong><br>
          <div>Contact: ${contact.name || d.contactName || '—'}</div>
          <div style="margin:8px 0; color:var(--success); font-weight:600;">
            R ${(Number(d.value)||0).toLocaleString()}
          </div>
          <div>Stage: ${d.stage || 'Unknown'}</div>
          <div class="deal-actions">
            <button class="btn-small btn-edit" onclick="openEditDealModal('${id}')">Edit</button>
            <button class="btn-small btn-delete" onclick="promptDeleteDeal('${id}')">Delete</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function resetFilters() {
      document.getElementById('dealSearch').value = '';
      document.getElementById('dealStageFilter').value = '';
      document.getElementById('dealValueFilter').value = '';
      filterDeals();
    }

    // ────────────────────────────────────────────────
    //  Deal Modal + CRUD
    // ────────────────────────────────────────────────
    function updateContactDropdown() {
      const select = document.getElementById('dealContactSelect');
      select.innerHTML = '<option value="">-- Select or type new --</option>';
      Object.entries(contactsData).forEach(([id, c]) => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `${c.name} (${c.company || 'No company'})`;
        select.appendChild(opt);
      });
    }

    document.getElementById('dealContactSelect')?.addEventListener('change', function() {
      document.getElementById('dealNewContactName').style.display = this.value === '' ? 'block' : 'none';
    });

    function openNewDealModal() {
      editingDealId = null;
      document.getElementById('dealModalTitle').textContent = "New Deal";
      document.getElementById('dealContactSelect').value = "";
      document.getElementById('dealNewContactName').value = "";
      document.getElementById('dealNewContactName').style.display = 'none';
      document.getElementById('dealCompany').value = "";
      document.getElementById('dealValue').value = "0";
      document.getElementById('dealStage').value = "proposal";
      const def = new Date(new Date().setMonth(new Date().getMonth() + 3)).toISOString().split('T')[0];
      document.getElementById('dealClose').value = def;
      document.getElementById('dealModalOverlay').style.display = 'flex';
    }

    function openEditDealModal(dealId) {
      const deal = dealsData[dealId];
      if (!deal) return showToast("Deal not found");

      editingDealId = dealId;

      document.getElementById('dealModalTitle').textContent = "Edit Deal";
      document.getElementById('dealContactSelect').value = deal.contactId || "";
      document.getElementById('dealNewContactName').value = "";
      document.getElementById('dealNewContactName').style.display = deal.contactId ? 'none' : 'block';
      document.getElementById('dealCompany').value = deal.company || "";
      document.getElementById('dealValue').value = deal.value || "0";
      document.getElementById('dealStage').value = deal.stage || "proposal";
      document.getElementById('dealClose').value = deal.expectedClose || "";
      document.getElementById('dealModalOverlay').style.display = 'flex';
    }

    async function saveDeal() {
      const contactSelect = document.getElementById('dealContactSelect').value;
      let contactId = contactSelect;
      const newContactName = document.getElementById('dealNewContactName').value.trim();

      if (!contactId && newContactName) {
        const ref = db.ref('contacts').push();
        contactId = ref.key;
        await ref.set({
          name: newContactName,
          owner: currentUser.uid,
          created: Date.now()
        });
      }

      if (!contactId) return showToast("Select or enter a contact");

      const dealData = {
        contactId,
        contactName: newContactName || contactsData[contactId]?.name || 'Unknown',
        company: document.getElementById('dealCompany').value.trim(),
        value: Number(document.getElementById('dealValue').value) || 0,
        stage: document.getElementById('dealStage').value,
        expectedClose: document.getElementById('dealClose').value || "",
        owner: currentUser.uid,
        lastActivity: Date.now()
      };

      if (editingDealId) {
        dealData.created = dealsData[editingDealId].created;
      } else {
        dealData.created = Date.now();
      }

      document.getElementById('savingOverlay').style.display = 'flex';

      try {
        if (editingDealId) {
          await db.ref(`deals/${editingDealId}`).update(dealData);
          showToast("Deal updated");
        } else {
          await db.ref('deals').push(dealData);
          showToast("Deal created");
        }
        closeDealModal();
      } catch (err) {
        showToast("Error saving deal: " + err.message);
      } finally {
        document.getElementById('savingOverlay').style.display = 'none';
      }
    }

    function closeDealModal() {
      document.getElementById('dealModalOverlay').style.display = 'none';
      editingDealId = null;
    }

    // ────────────────────────────────────────────────
    //  Delete Confirmation
    // ────────────────────────────────────────────────
    function promptDeleteDeal(dealId) {
      currentDeleteDealId = dealId;
      document.getElementById('confirmModalOverlay').style.display = 'flex';
    }

    function closeConfirmModal() {
      document.getElementById('confirmModalOverlay').style.display = 'none';
      currentDeleteDealId = null;
    }

    async function confirmDelete() {
      if (!currentDeleteDealId) return;
      document.getElementById('savingOverlay').style.display = 'flex';
      document.getElementById('confirmModalOverlay').style.display = 'none';

      try {
        await db.ref(`deals/${currentDeleteDealId}`).remove();
        showToast("Deal deleted");
      } catch (err) {
        showToast("Error deleting deal: " + err.message);
      } finally {
        document.getElementById('savingOverlay').style.display = 'none';
        currentDeleteDealId = null;
      }
    }

    // ────────────────────────────────────────────────
    //  Contact CRUD
    // ────────────────────────────────────────────────
    async function saveContact() {
      const name = document.getElementById('contactName').value.trim();
      if (!name) return showToast("Name is required");

      document.getElementById('savingOverlay').style.display = 'flex';

      const data = {
        name,
        company: document.getElementById('contactCompany').value.trim(),
        email: document.getElementById('contactEmail').value.trim(),
        phone: document.getElementById('contactPhone').value.trim(),
        owner: currentUser.uid,
        created: Date.now()
      };

      try {
        await db.ref('contacts').push(data);
        showToast("Contact added");
        closeContactModal();
      } catch (err) {
        showToast("Error: " + err.message);
      } finally {
        document.getElementById('savingOverlay').style.display = 'none';
      }
    }

    function openNewContactModal() {
      document.getElementById('contactModalTitle').textContent = "New Contact";
      document.getElementById('contactName').value = "";
      document.getElementById('contactCompany').value = "";
      document.getElementById('contactEmail').value = "";
      document.getElementById('contactPhone').value = "";
      document.getElementById('contactModalOverlay').style.display = 'flex';
    }

    function closeContactModal() {
      document.getElementById('contactModalOverlay').style.display = 'none';
    }

    // ────────────────────────────────────────────────
    //  Sidebar & Navigation
    // ────────────────────────────────────────────────
    function expandSidebar() { if (window.innerWidth >= 992) document.getElementById('sideDrawer').classList.add('expanded'); }
    function collapseSidebar() { if (window.innerWidth >= 992) document.getElementById('sideDrawer').classList.remove('expanded'); }
    function toggleDrawer() { document.getElementById('sideDrawer').classList.toggle('open'); }

    document.querySelectorAll('.drawer-item[data-section]').forEach(item => {
      item.addEventListener('click', () => {
        const section = item.getAttribute('data-section');
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(section).classList.add('active');
        document.getElementById('pageTitle').textContent = section.charAt(0).toUpperCase() + section.slice(1);
        document.getElementById('actionBtn').style.display = (section === 'deals') ? 'flex' : 'none';
        if (window.innerWidth < 992) toggleDrawer();
      });
    });

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3200);
    }

    function logout() { auth.signOut().then(() => window.location.href = "login.html"); }

    // Close modals on overlay click
    document.getElementById('dealModalOverlay')?.addEventListener('click', e => { if (e.target === document.getElementById('dealModalOverlay')) closeDealModal(); });
    document.getElementById('contactModalOverlay')?.addEventListener('click', e => { if (e.target === document.getElementById('contactModalOverlay')) closeContactModal(); });
    document.getElementById('confirmModalOverlay')?.addEventListener('click', e => { if (e.target === document.getElementById('confirmModalOverlay')) closeConfirmModal(); });
  </script>
</body>
</html>
