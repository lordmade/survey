<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VynixCRM • Business Solution</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-remote-config-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #6366f1; /* Indigo */
            --primary-dark: #4f46e5;
            --bg-body: #f3f4f6;
            --surface: #ffffff;
            --text-main: #111827;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --sidebar-w: 260px;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* ── Auth Screen ── */
        #authScreen {
            position: fixed; inset: 0; z-index: 100;
            background: var(--bg-body);
            display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            background: var(--surface); padding: 40px; border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; width: 100%; max-width: 400px;
        }

        /* ── Sidebar ── */
        .sidebar {
            width: var(--sidebar-w); background: var(--surface); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s;
        }
        .brand {
            padding: 24px; font-size: 1.25rem; font-weight: 700; color: var(--primary);
            display: flex; align-items: center; gap: 10px;
        }
        .nav-links { flex: 1; padding: 0 16px; }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            color: var(--text-sub); text-decoration: none; border-radius: 8px; margin-bottom: 4px;
            cursor: pointer; transition: all 0.2s; font-weight: 500; font-size: 0.95rem;
        }
        .nav-item:hover { background: #f9fafb; color: var(--text-main); }
        .nav-item.active { background: #eef2ff; color: var(--primary); }
        .user-mini {
            padding: 20px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 12px;
        }

        /* ── Main Layout ── */
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        
        .top-bar {
            height: 64px; border-bottom: 1px solid var(--border); background: var(--surface);
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
        }
        .page-title { font-size: 1.1rem; font-weight: 600; }
        .action-btn {
            background: var(--primary); color: white; border: none; padding: 8px 16px;
            border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; gap: 8px; transition: background 0.2s;
        }
        .action-btn:hover { background: var(--primary-dark); }

        /* ── Views Container ── */
        .view-container { flex: 1; overflow-y: auto; padding: 24px; display: none; }
        .view-container.active { display: block; }

        /* ── Dashboard Cards ── */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .stat-card { background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-val { font-size: 1.8rem; font-weight: 700; margin: 8px 0; }
        .stat-label { color: var(--text-sub); font-size: 0.875rem; }

        /* ── Kanban Pipeline ── */
        .pipeline-wrapper { display: flex; gap: 24px; height: 100%; overflow-x: auto; padding-bottom: 10px; }
        .pipeline-col {
            min-width: 300px; background: #f9fafb; border-radius: 12px;
            display: flex; flex-direction: column; height: 100%; border: 1px solid var(--border);
        }
        .col-header { padding: 16px; font-weight: 600; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .col-body { padding: 12px; flex: 1; overflow-y: auto; }
        
        .deal-card {
            background: var(--surface); padding: 16px; border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 12px; cursor: pointer;
            border: 1px solid transparent; transition: all 0.2s;
        }
        .deal-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .deal-price { font-weight: 600; color: var(--text-main); margin-top: 8px; }
        .tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; background: #eef2ff; color: var(--primary); }

        /* ── Table View ── */
        .data-table { width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px; overflow: hidden; }
        .data-table th, .data-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border); }
        .data-table th { background: #f9fafb; font-weight: 600; color: var(--text-sub); font-size: 0.875rem; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .status-new { background: #eff6ff; color: #1d4ed8; }
        .status-won { background: #ecfdf5; color: #047857; }
        .status-lost { background: #fef2f2; color: #b91c1c; }

        /* ── AI Assistant FAB ── */
        .ai-fab {
            position: absolute; bottom: 30px; right: 30px;
            width: 60px; height: 60px; border-radius: 30px;
            background: var(--text-main); color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            z-index: 90; transition: transform 0.2s;
        }
        .ai-fab:hover { transform: scale(1.1); }
        
        /* ── AI Chat Window ── */
        .ai-window {
            position: absolute; bottom: 100px; right: 30px;
            width: 350px; height: 500px;
            background: white; border-radius: 16px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            display: none; flex-direction: column; z-index: 95;
            border: 1px solid var(--border);
        }
        .ai-header {
            padding: 16px; border-bottom: 1px solid var(--border); background: #f9fafb;
            border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;
        }
        .ai-body { flex: 1; padding: 16px; overflow-y: auto; background: #fff; }
        .ai-msg { margin-bottom: 12px; padding: 10px; border-radius: 8px; font-size: 0.9rem; line-height: 1.4; }
        .ai-msg.bot { background: #f0f7ff; color: var(--text-main); border-left: 3px solid var(--primary); }
        .ai-msg.user { background: #f3f4f6; text-align: right; margin-left: auto; width: 80%; }
        
        .ai-input-area {
            padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px;
        }
        .ai-input { flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 20px; outline: none; }

        /* ── Modal ── */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .modal { background: var(--surface); width: 100%; max-width: 500px; border-radius: 12px; padding: 24px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-size: 0.875rem; font-weight: 500; }
        .form-input {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;
            font-size: 0.95rem; outline: none;
        }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        
        .btn-row { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
        .btn-cancel { background: white; border: 1px solid var(--border); color: var(--text-main); padding: 8px 16px; border-radius: 8px; cursor: pointer; }
        
        /* Mobile Toggle */
        .menu-toggle { display: none; background: none; border: none; cursor: pointer; }
        @media(max-width: 768px) {
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .menu-toggle { display: block; }
            .pipeline-wrapper { flex-direction: column; overflow-x: hidden; overflow-y: auto; }
            .pipeline-col { min-width: 100%; min-height: 200px; margin-bottom: 20px; }
            .ai-window { width: 90%; right: 5%; bottom: 100px; }
        }
    </style>
</head>
<body>

    <div id="authScreen">
        <div class="login-card">
            <div style="width: 50px; height: 50px; background: var(--primary); border-radius: 12px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                <span class="material-symbols-rounded" style="color:white; font-size: 28px;">pie_chart</span>
            </div>
            <h1 style="font-size: 1.5rem; margin-bottom: 8px;">VynixCRM</h1>
            <p style="color: var(--text-sub); margin-bottom: 30px;">Manage your customer relationships efficiently.</p>
            <button onclick="signIn()" class="action-btn" style="width: 100%; justify-content: center; height: 44px;">
                Sign in with Google
            </button>
        </div>
    </div>

    <div id="appLayout" style="display: none; width: 100%;">
        
        <aside class="sidebar" id="sidebar">
            <div class="brand">
                <span class="material-symbols-rounded">pie_chart</span>
                VynixCRM
            </div>
            <nav class="nav-links">
                <a class="nav-item active" onclick="nav('dashboard', this)">
                    <span class="material-symbols-rounded">dashboard</span> Dashboard
                </a>
                <a class="nav-item" onclick="nav('pipeline', this)">
                    <span class="material-symbols-rounded">view_kanban</span> Pipeline
                </a>
                <a class="nav-item" onclick="nav('contacts', this)">
                    <span class="material-symbols-rounded">groups</span> Contacts
                </a>
            </nav>
            <div class="user-mini">
                <img id="userAvatar" src="" style="width: 32px; height: 32px; border-radius: 50%; background: #ddd;">
                <div style="flex:1; overflow:hidden;">
                    <div id="userName" style="font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">User</div>
                    <div id="userEmail" style="font-size: 0.75rem; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">email@ex.com</div>
                </div>
                <button onclick="signOut()" style="border:none; background:none; cursor:pointer; color: var(--text-sub);">
                    <span class="material-symbols-rounded">logout</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div style="display:flex; align-items:center; gap:12px;">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <span class="material-symbols-rounded">menu</span>
                    </button>
                    <span class="page-title" id="pageTitle">Dashboard</span>
                </div>
                <button class="action-btn" onclick="openModal()">
                    <span class="material-symbols-rounded">add</span> New Deal
                </button>
            </header>

            <div id="view-dashboard" class="view-container active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="material-symbols-rounded" style="color: var(--primary);">monetization_on</span>
                        <div class="stat-val" id="statRevenue">R0</div>
                        <div class="stat-label">Total Pipeline Value</div>
                    </div>
                    <div class="stat-card">
                        <span class="material-symbols-rounded" style="color: var(--success);">check_circle</span>
                        <div class="stat-val" id="statWon">0</div>
                        <div class="stat-label">Deals Won</div>
                    </div>
                    <div class="stat-card">
                        <span class="material-symbols-rounded" style="color: var(--warning);">trending_up</span>
                        <div class="stat-val" id="statOpen">0</div>
                        <div class="stat-label">Open Deals</div>
                    </div>
                </div>
                <div style="background: white; padding: 24px; border-radius: 12px; border: 1px solid var(--border); height: 300px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div id="view-pipeline" class="view-container" style="overflow: hidden; display: none;">
                <div class="pipeline-wrapper">
                    <div class="pipeline-col">
                        <div class="col-header">
                            <span>New Leads</span>
                            <span class="tag" id="count-lead">0</span>
                        </div>
                        <div class="col-body" id="col-lead" ondrop="drop(event, 'lead')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="pipeline-col">
                        <div class="col-header">
                            <span>Negotiation</span>
                            <span class="tag" id="count-negotiation">0</span>
                        </div>
                        <div class="col-body" id="col-negotiation" ondrop="drop(event, 'negotiation')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="pipeline-col">
                        <div class="col-header" style="border-bottom-color: var(--success);">
                            <span style="color: var(--success);">Won</span>
                            <span class="tag" id="count-won">0</span>
                        </div>
                        <div class="col-body" id="col-won" ondrop="drop(event, 'won')" ondragover="allowDrop(event)"></div>
                    </div>
                </div>
            </div>

            <div id="view-contacts" class="view-container" style="display: none;">
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Company</th>
                                <th>Value (ZAR)</th>
                                <th>Stage</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contactsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <button class="ai-fab" onclick="toggleAIWindow()">
                <span class="material-symbols-rounded">smart_toy</span>
            </button>

            <div id="aiWindow" class="ai-window">
                <div class="ai-header">
                    <span style="font-weight:600; display:flex; align-items:center; gap:8px;">
                        <span class="material-symbols-rounded" style="color:var(--primary); font-size:20px;">smart_toy</span>
                        AI Assistant
                    </span>
                    <button onclick="toggleAIWindow()" style="background:none; border:none; cursor:pointer;">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <div class="ai-body" id="aiChatBody">
                    <div class="ai-msg bot">Hello Vynix! How can I assist you with your CRM today? I can help write emails or analyze your sales pipeline.</div>
                </div>
                <div class="ai-input-area">
                    <input type="text" id="aiGlobalInput" class="ai-input" placeholder="Ask AI..." onkeypress="if(event.key === 'Enter') sendGlobalAI()">
                    <button onclick="sendGlobalAI()" style="background:var(--primary); color:white; border:none; width:32px; height:32px; border-radius:50%; cursor:pointer;">
                        <span class="material-symbols-rounded" style="font-size:18px;">send</span>
                    </button>
                </div>
            </div>

        </main>
    </div>

    <div class="modal-overlay" id="dealModal">
        <div class="modal">
            <h2 style="margin-bottom: 20px;">Deal Details</h2>
            <form id="dealForm" onsubmit="saveDeal(event)">
                <input type="hidden" id="dealId">
                <div class="form-group">
                    <label class="form-label">Client Name</label>
                    <input type="text" id="inpName" class="form-input" required placeholder="e.g. Thabo Mbeki">
                </div>
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" id="inpCompany" class="form-input" placeholder="e.g. Solutions Pty">
                </div>
                <div class="form-group">
                    <label class="form-label">Deal Value (R)</label>
                    <input type="number" id="inpValue" class="form-input" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Stage</label>
                    <select id="inpStage" class="form-input">
                        <option value="lead">New Lead</option>
                        <option value="negotiation">Negotiation</option>
                        <option value="won">Closed Won</option>
                        <option value="lost">Closed Lost</option>
                    </select>
                </div>
                
                <div style="margin-top:20px; padding:12px; background:#f0f7ff; border-radius:8px; border:1px dashed #6366f1;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.85rem; font-weight:600; color:#4f46e5;">AI Email Draft</span>
                        <button type="button" onclick="generateContextEmail()" style="background:#fff; border:1px solid #ddd; padding:4px 8px; font-size:0.75rem; border-radius:4px; cursor:pointer; color: var(--text-main);">
                            Generate Draft
                        </button>
                    </div>
                    <textarea id="aiOutput" style="width:100%; height:80px; margin-top:8px; border:1px solid #ddd; border-radius:4px; font-size:0.8rem; padding:8px; display:none; resize:none;"></textarea>
                </div>

                <div class="btn-row">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="action-btn">Save Deal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ── Firebase Config ──
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            projectId: "fire-b-a8878",
            databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const provider = new firebase.auth.GoogleAuthProvider();
        const remoteConfig = firebase.remoteConfig();

        // ── State ──
        let currentUser = null;
        let deals = [];
        let chartInstance = null;
        let XAI_API_KEY = "";
        const currencyFmt = new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR' });

        // ── Auth Logic ──
        function signIn() { auth.signInWithPopup(provider); }
        function signOut() { auth.signOut().then(() => location.reload()); }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('appLayout').style.display = 'flex';
                document.getElementById('userAvatar').src = user.photoURL;
                document.getElementById('userName').innerText = user.displayName;
                document.getElementById('userEmail').innerText = user.email;
                
                fetchConfig();
                initRealtimeListener();
            } else {
                document.getElementById('authScreen').style.display = 'flex';
            }
        });

        function fetchConfig() {
            remoteConfig.settings = { minimumFetchIntervalMillis: 0 };
            remoteConfig.fetchAndActivate().then(() => {
                XAI_API_KEY = remoteConfig.getValue('xai_api_key').asString();
            }).catch(err => console.error("Config error", err));
        }

        // ── Data Sync ──
        function initRealtimeListener() {
            const ref = db.ref(`crm/${currentUser.uid}/deals`);
            ref.on('value', snapshot => {
                deals = [];
                snapshot.forEach(child => {
                    deals.push({ id: child.key, ...child.val() });
                });
                renderAll();
            });
        }

        function renderAll() {
            updateDashboard();
            renderPipeline();
            renderContacts();
        }

        // ── Dashboard ──
        function updateDashboard() {
            const totalVal = deals.reduce((acc, d) => acc + (parseFloat(d.value)||0), 0);
            const wonCount = deals.filter(d => d.stage === 'won').length;
            const openCount = deals.filter(d => d.stage !== 'won' && d.stage !== 'lost').length;

            // Updated for Rands
            document.getElementById('statRevenue').innerText = currencyFmt.format(totalVal).replace('ZAR', 'R');
            document.getElementById('statWon').innerText = wonCount;
            document.getElementById('statOpen').innerText = openCount;

            // Chart
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const dataCounts = [
                deals.filter(d => d.stage === 'lead').length,
                deals.filter(d => d.stage === 'negotiation').length,
                deals.filter(d => d.stage === 'won').length
            ];

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Lead', 'Negotiation', 'Won'],
                    datasets: [{
                        label: 'Deals Count',
                        data: dataCounts,
                        backgroundColor: ['#6366f1', '#f59e0b', '#10b981'],
                        borderRadius: 6
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
            });
        }

        // ── Pipeline (Kanban) ──
        function renderPipeline() {
            ['lead', 'negotiation', 'won'].forEach(stage => {
                const col = document.getElementById(`col-${stage}`);
                const countBadge = document.getElementById(`count-${stage}`);
                col.innerHTML = '';
                
                const stageDeals = deals.filter(d => d.stage === stage);
                countBadge.innerText = stageDeals.length;

                stageDeals.forEach(deal => {
                    const card = document.createElement('div');
                    card.className = 'deal-card';
                    card.draggable = true;
                    card.ondragstart = (e) => drag(e, deal.id);
                    card.onclick = () => editDeal(deal);
                    card.innerHTML = `
                        <div style="font-weight:500;">${deal.clientName}</div>
                        <div style="font-size:0.8rem; color:var(--text-sub);">${deal.company || ''}</div>
                        <div class="deal-price">${currencyFmt.format(deal.value).replace('ZAR', 'R')}</div>
                    `;
                    col.appendChild(card);
                });
            });
        }

        // ── Drag & Drop Logic ──
        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev, id) { ev.dataTransfer.setData("text", id); }
        function drop(ev, newStage) {
            ev.preventDefault();
            const id = ev.dataTransfer.getData("text");
            db.ref(`crm/${currentUser.uid}/deals/${id}`).update({ stage: newStage });
        }

        // ── Contacts (Table) ──
        function renderContacts() {
            const tbody = document.getElementById('contactsTableBody');
            tbody.innerHTML = '';
            deals.forEach(deal => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:500">${deal.clientName}</td>
                    <td>${deal.company || '-'}</td>
                    <td>${currencyFmt.format(deal.value).replace('ZAR', 'R')}</td>
                    <td><span class="status-badge status-${deal.stage}">${deal.stage.toUpperCase()}</span></td>
                    <td>
                        <button onclick="deleteDeal('${deal.id}')" style="color:var(--danger); background:none; border:none; cursor:pointer;">
                            <span class="material-symbols-rounded">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ── Modal & Form ──
        function openModal(deal = null) {
            document.getElementById('dealModal').style.display = 'flex';
            const f = document.getElementById('dealForm');
            f.reset();
            document.getElementById('aiOutput').style.display = 'none';
            if (deal) {
                document.getElementById('dealId').value = deal.id;
                document.getElementById('inpName').value = deal.clientName;
                document.getElementById('inpCompany').value = deal.company;
                document.getElementById('inpValue').value = deal.value;
                document.getElementById('inpStage').value = deal.stage;
            } else {
                document.getElementById('dealId').value = '';
                document.getElementById('inpStage').value = 'lead';
            }
        }
        function closeModal() { document.getElementById('dealModal').style.display = 'none'; }
        function editDeal(deal) { openModal(deal); }

        function saveDeal(e) {
            e.preventDefault();
            const id = document.getElementById('dealId').value;
            const data = {
                clientName: document.getElementById('inpName').value,
                company: document.getElementById('inpCompany').value,
                value: document.getElementById('inpValue').value,
                stage: document.getElementById('inpStage').value,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            if (id) db.ref(`crm/${currentUser.uid}/deals/${id}`).update(data);
            else db.ref(`crm/${currentUser.uid}/deals`).push(data);
            closeModal();
        }

        function deleteDeal(id) {
            if(confirm("Are you sure?")) db.ref(`crm/${currentUser.uid}/deals/${id}`).remove();
        }

        // ── AI FUNCTIONALITY ──

        // 1. Context Email (Inside Deal Modal)
        async function generateContextEmail() {
            if (!XAI_API_KEY) return alert("AI Key not loaded.");
            
            const name = document.getElementById('inpName').value;
            const company = document.getElementById('inpCompany').value;
            const stage = document.getElementById('inpStage').value;
            const output = document.getElementById('aiOutput');
            
            if(!name) return alert("Please enter client name first.");

            output.style.display = 'block';
            output.value = "Thinking...";

            let contextPrompt = "";
            if(stage === 'lead') contextPrompt = "an introductory email offering services";
            else if(stage === 'negotiation') contextPrompt = "a follow-up regarding our proposal and pricing in Rands";
            else if(stage === 'won') contextPrompt = "a thank you email for closing the deal";
            else contextPrompt = "a polite re-engagement email";

            const prompt = `Write ${contextPrompt} to ${name} from ${company}. Keep it professional, concise, and use South African English spelling. Sender: Vynix Lingua.`;

            await callAI(prompt, (text) => { output.value = text; });
        }

        // 2. Global AI Chat
        function toggleAIWindow() {
            const w = document.getElementById('aiWindow');
            w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
        }

        async function sendGlobalAI() {
            const input = document.getElementById('aiGlobalInput');
            const body = document.getElementById('aiChatBody');
            const txt = input.value.trim();
            if(!txt) return;

            // User msg
            body.innerHTML += `<div class="ai-msg user">${txt}</div>`;
            input.value = '';
            body.scrollTop = body.scrollHeight;

            // Loading msg
            const loadingId = 'loading-' + Date.now();
            body.innerHTML += `<div id="${loadingId}" class="ai-msg bot">...</div>`;

            // Prepare context
            const totalVal = deals.reduce((acc, d) => acc + (parseFloat(d.value)||0), 0);
            const contextData = `The user has ${deals.length} deals. Total value: R${totalVal}. Won: ${deals.filter(d=>d.stage=='won').length}.`;
            
            const prompt = `Context: ${contextData}. User Name: Vynix Lingua. Request: ${txt}. Answer briefly.`;

            await callAI(prompt, (text) => {
                document.getElementById(loadingId).innerText = text;
                body.scrollTop = body.scrollHeight;
            });
        }

        // Shared AI Caller
        async function callAI(prompt, callback) {
            try {
                const res = await fetch("https://api.x.ai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${XAI_API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "grok-beta",
                        messages: [{role: "user", content: prompt}],
                        temperature: 0.7
                    })
                });
                const json = await res.json();
                callback(json.choices[0].message.content);
            } catch (err) {
                console.error(err);
                callback("Error connecting to AI.");
            }
        }

        // ── Navigation ──
        function nav(viewName, btn) {
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`view-${viewName}`).classList.add('active');
            btn.classList.add('active');
            
            const titles = { dashboard: 'Dashboard', pipeline: 'Sales Pipeline', contacts: 'Client List' };
            document.getElementById('pageTitle').innerText = titles[viewName];
            
            if(window.innerWidth <= 768) toggleSidebar();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
    </script>
</body>
</html>
