<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VynixCRM • Business Solution</title>
   
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-remote-config-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-body: #f3f4f6;
            --surface: #ffffff;
            --text-main: #111827;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --sidebar-w: 260px;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        #authScreen {
            position: fixed; inset: 0; z-index: 100;
            background: var(--bg-body);
            display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            background: var(--surface); padding: 40px; border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; width: 100%; max-width: 400px;
        }

        .sidebar {
            width: var(--sidebar-w); background: var(--surface); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s;
        }
        .brand {
            padding: 24px; font-size: 1.25rem; font-weight: 700; color: var(--primary);
            display: flex; align-items: center; gap: 10px;
        }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            color: var(--text-sub); text-decoration: none; border-radius: 8px; margin-bottom: 4px;
            cursor: pointer; transition: all 0.2s; font-weight: 500; font-size: 0.95rem;
        }
        .nav-item:hover { background: #f9fafb; color: var(--text-main); }
        .nav-item.active { background: #eef2ff; color: var(--primary); }
        .user-mini {
            padding: 20px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 12px;
        }

        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .top-bar {
            height: 64px; border-bottom: 1px solid var(--border); background: var(--surface);
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
        }
        .page-title { font-size: 1.1rem; font-weight: 600; }
        .action-btn {
            background: var(--primary); color: white; border: none; padding: 8px 16px;
            border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; gap: 8px; transition: background 0.2s;
        }
        .action-btn:hover { background: var(--primary-dark); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .view-container { flex: 1; overflow-y: auto; padding: 24px; display: none; }
        .view-container.active { display: block; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .stat-card { background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-val { font-size: 1.8rem; font-weight: 700; margin: 8px 0; }
        .stat-label { color: var(--text-sub); font-size: 0.875rem; }

        .pipeline-wrapper { display: flex; gap: 24px; height: 100%; overflow-x: auto; padding-bottom: 10px; }
        .pipeline-col {
            min-width: 300px; background: #f9fafb; border-radius: 12px;
            display: flex; flex-direction: column; height: 100%; border: 1px solid var(--border);
        }
        .col-header { padding: 16px; font-weight: 600; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .col-body { padding: 12px; flex: 1; overflow-y: auto; }

        .deal-card {
            background: var(--surface); padding: 16px; border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 12px; cursor: pointer;
            border: 1px solid transparent; transition: all 0.2s;
        }
        .deal-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .deal-price { font-weight: 600; color: var(--text-main); margin-top: 8px; }
        .tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; background: #eef2ff; color: var(--primary); }

        .data-table { width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px; overflow: hidden; }
        .data-table th, .data-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border); }
        .data-table th { background: #f9fafb; font-weight: 600; color: var(--text-sub); font-size: 0.875rem; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .status-lead { background: #eff6ff; color: #1d4ed8; }
        .status-negotiation { background: #fefce8; color: #854d0e; }
        .status-won { background: #ecfdf5; color: #047857; }
        .status-lost { background: #fef2f2; color: #b91c1c; }

        .ai-fab {
            position: absolute; bottom: 30px; right: 30px;
            width: 60px; height: 60px; border-radius: 30px;
            background: var(--text-main); color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            z-index: 90; transition: transform 0.2s;
        }
        .ai-fab:hover { transform: scale(1.1); }

        .ai-window {
            position: absolute; bottom: 100px; right: 30px;
            width: 350px; height: 500px;
            background: white; border-radius: 16px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            display: none; flex-direction: column; z-index: 95;
            border: 1px solid var(--border);
        }
        .ai-header {
            padding: 16px; border-bottom: 1px solid var(--border); background: #f9fafb;
            border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;
        }
        .ai-body { flex: 1; padding: 16px; overflow-y: auto; background: #fff; }
        .ai-msg { margin-bottom: 12px; padding: 10px; border-radius: 8px; font-size: 0.9rem; line-height: 1.4; }
        .ai-msg.bot { background: #f0f7ff; color: var(--text-main); border-left: 3px solid var(--primary); }
        .ai-msg.user { background: #f3f4f6; text-align: right; margin-left: auto; width: 80%; }

        .ai-input-area {
            padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px;
        }
        .ai-input { flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 20px; outline: none; }

        /* ── Custom Modal ── */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .modal {
            background: var(--surface); width: 100%; max-width: 500px; border-radius: 12px; padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .modal-header { font-size: 1.25rem; font-weight: 600; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { margin-bottom: 24px; line-height: 1.5; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; }

        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; border: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: #f9fafb; }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-size: 0.875rem; font-weight: 500; }
        .form-input, .form-select {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;
            font-size: 0.95rem; outline: none;
        }
        .form-input:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,0.15); }
        .form-error { color: var(--danger); font-size: 0.8rem; margin-top: 4px; display: none; }

        .ai-fab, .menu-toggle { background: none; border: none; cursor: pointer; }

        @media(max-width: 768px) {
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .menu-toggle { display: block; }
            .pipeline-wrapper { flex-direction: column; overflow-x: hidden; overflow-y: auto; }
            .pipeline-col { min-width: 100%; min-height: 200px; margin-bottom: 20px; }
            .ai-window { width: 90%; right: 5%; bottom: 100px; }
            .modal { max-width: 90%; }
        }
    </style>
</head>
<body>

    <!-- Auth Screen -->
    <div id="authScreen">
        <div class="login-card">
            <div style="width: 50px; height: 50px; background: var(--primary); border-radius: 12px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                <span class="material-symbols-rounded" style="color:white; font-size: 28px;">pie_chart</span>
            </div>
            <h1 style="font-size: 1.5rem; margin-bottom: 8px;">VynixCRM</h1>
            <p style="color: var(--text-sub); margin-bottom: 30px;">Manage your customer relationships efficiently.</p>
            <button onclick="signIn()" class="action-btn" style="width: 100%; justify-content: center; height: 44px;">
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main App Layout -->
    <div id="appLayout" style="display: none; width: 100%; height: 100%;">
        <aside class="sidebar" id="sidebar">
            <div class="brand">
                <span class="material-symbols-rounded">pie_chart</span>
                VynixCRM
            </div>
            <nav class="nav-links">
                <div class="nav-item active" onclick="nav('dashboard', this)"><span class="material-symbols-rounded">dashboard</span> Dashboard</div>
                <div class="nav-item" onclick="nav('pipeline', this)"><span class="material-symbols-rounded">view_kanban</span> Pipeline</div>
                <div class="nav-item" onclick="nav('contacts', this)"><span class="material-symbols-rounded">groups</span> Contacts</div>
            </nav>
            <div class="user-mini">
                <img id="userAvatar" src="" style="width: 32px; height: 32px; border-radius: 50%; background: #ddd;">
                <div style="flex:1; overflow:hidden;">
                    <div id="userName" style="font-size: 0.9rem; font-weight: 600;">User</div>
                    <div id="userEmail" style="font-size: 0.75rem; color: var(--text-sub);">email@ex.com</div>
                </div>
                <button onclick="signOut()">
                    <span class="material-symbols-rounded">logout</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div style="display:flex; align-items:center; gap:12px;">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <span class="material-symbols-rounded">menu</span>
                    </button>
                    <span class="page-title" id="pageTitle">Dashboard</span>
                </div>
                <button class="action-btn" onclick="openDealModal()">
                    <span class="material-symbols-rounded">add</span> New Deal
                </button>
            </header>

            <!-- Dashboard -->
            <div id="view-dashboard" class="view-container active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="material-symbols-rounded" style="color: var(--primary);">monetization_on</span>
                        <div class="stat-val" id="statRevenue">R0.00</div>
                        <div class="stat-label">Total Pipeline Value</div>
                    </div>
                    <div class="stat-card">
                        <span class="material-symbols-rounded" style="color: var(--success);">check_circle</span>
                        <div class="stat-val" id="statWon">0</div>
                        <div class="stat-label">Deals Won</div>
                    </div>
                    <div class="stat-card">
                        <span class="material-symbols-rounded" style="color: var(--warning);">trending_up</span>
                        <div class="stat-val" id="statOpen">0</div>
                        <div class="stat-label">Open Deals</div>
                    </div>
                </div>
                <div style="background: white; padding: 24px; border-radius: 12px; border: 1px solid var(--border); height: 320px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- Pipeline -->
            <div id="view-pipeline" class="view-container">
                <div class="pipeline-wrapper">
                    <div class="pipeline-col">
                        <div class="col-header"><span>New Leads</span><span class="tag" id="count-lead">0</span></div>
                        <div class="col-body" id="col-lead" ondrop="drop(event, 'lead')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="pipeline-col">
                        <div class="col-header"><span>Negotiation</span><span class="tag" id="count-negotiation">0</span></div>
                        <div class="col-body" id="col-negotiation" ondrop="drop(event, 'negotiation')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="pipeline-col">
                        <div class="col-header" style="border-bottom-color: var(--success);">
                            <span style="color: var(--success);">Won</span><span class="tag" id="count-won">0</span>
                        </div>
                        <div class="col-body" id="col-won" ondrop="drop(event, 'won')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="pipeline-col">
                        <div class="col-header" style="border-bottom-color: var(--danger);">
                            <span style="color: var(--danger);">Lost</span><span class="tag" id="count-lost">0</span>
                        </div>
                        <div class="col-body" id="col-lost" ondrop="drop(event, 'lost')" ondragover="allowDrop(event)"></div>
                    </div>
                </div>
            </div>

            <!-- Contacts -->
            <div id="view-contacts" class="view-container">
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Company</th>
                                <th>Value (ZAR)</th>
                                <th>Stage</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contactsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- AI FAB + Window -->
            <button class="ai-fab" onclick="toggleAIWindow()">
                <span class="material-symbols-rounded">smart_toy</span>
            </button>
            <div id="aiWindow" class="ai-window">
                <div class="ai-header">
                    <span style="font-weight:600; display:flex; align-items:center; gap:8px;">
                        <span class="material-symbols-rounded" style="color:var(--primary); font-size:20px;">smart_toy</span>
                        AI Assistant
                    </span>
                    <button onclick="toggleAIWindow()" style="background:none;border:none;cursor:pointer;">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <div class="ai-body" id="aiChatBody">
                    <div class="ai-msg bot">Hello! How can I help with your CRM today?</div>
                </div>
                <div class="ai-input-area">
                    <input type="text" id="aiGlobalInput" class="ai-input" placeholder="Ask anything..." onkeypress="if(event.key==='Enter') sendGlobalAI()">
                    <button onclick="sendGlobalAI()" style="background:var(--primary);color:white;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;">
                        <span class="material-symbols-rounded" style="font-size:20px;">send</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Deal Form Modal -->
    <div class="modal-overlay" id="dealModal">
        <div class="modal">
            <div class="modal-header">
                <span id="dealModalTitle">New Deal</span>
                <button onclick="closeDealModal()" style="background:none;border:none;cursor:pointer;font-size:1.4rem;color:var(--text-sub);">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <form id="dealForm" onsubmit="saveDeal(event)">
                <input type="hidden" id="dealId">
                <div class="form-group">
                    <label class="form-label">Client Name *</label>
                    <input type="text" id="inpName" class="form-input" required placeholder="e.g. Thabo Mbeki">
                    <div class="form-error" id="errName">Client name is required</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" id="inpCompany" class="form-input" placeholder="e.g. Solutions Pty Ltd">
                </div>
                <div class="form-group">
                    <label class="form-label">Deal Value (R) *</label>
                    <input type="number" step="0.01" min="0" id="inpValue" class="form-input" required placeholder="0.00">
                    <div class="form-error" id="errValue">Please enter a valid amount</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Stage</label>
                    <select id="inpStage" class="form-select">
                        <option value="lead">New Lead</option>
                        <option value="negotiation">Negotiation</option>
                        <option value="won">Closed Won</option>
                        <option value="lost">Closed Lost</option>
                    </select>
                </div>

                <div style="margin: 20px 0; padding: 12px; background:#f0f7ff; border-radius:8px; border:1px dashed var(--primary);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <span style="font-weight:600; color:var(--primary);">AI Email Draft</span>
                        <button type="button" onclick="generateContextEmail()" class="btn btn-outline" style="font-size:0.85rem;padding:6px 12px;">
                            Generate
                        </button>
                    </div>
                    <textarea id="aiOutput" style="width:100%; height:90px; border:1px solid #ddd; border-radius:6px; padding:8px; font-size:0.85rem; resize:vertical; display:none;"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeDealModal()">Cancel</button>
                    <button type="submit" id="saveDealBtn" class="btn btn-primary">Save Deal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Alert / Confirm Modal -->
    <div class="modal-overlay" id="alertModal">
        <div class="modal" style="max-width:420px;">
            <div class="modal-header" id="alertTitle">Notification</div>
            <div class="modal-body" id="alertMessage"></div>
            <div class="modal-actions" id="alertActions"></div>
        </div>
    </div>

    <script>
        // ── Firebase ────────────────────────────────────────────────────────────────
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            projectId: "fire-b-a8878",
            databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const provider = new firebase.auth.GoogleAuthProvider();
        const remoteConfig = firebase.remoteConfig();

        let currentUser = null;
        let deals = [];
        let chartInstance = null;
        let XAI_API_KEY = "";
        const currencyFmt = new Intl.NumberFormat('en-ZA', { style: 'currency', currency: 'ZAR', minimumFractionDigits: 2 });

        // ── Auth ────────────────────────────────────────────────────────────────────
        function signIn() { auth.signInWithPopup(provider); }
        function signOut() { auth.signOut().then(() => location.reload()); }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('appLayout').style.display = 'flex';
                document.getElementById('userAvatar').src = user.photoURL || 'https://via.placeholder.com/32';
                document.getElementById('userName').innerText = user.displayName || 'User';
                document.getElementById('userEmail').innerText = user.email;

                fetchConfig();
                initRealtimeListener();
            } else {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('appLayout').style.display = 'none';
            }
        });

        function fetchConfig() {
            remoteConfig.settings = { minimumFetchIntervalMillis: 0 };
            remoteConfig.fetchAndActivate().then(() => {
                XAI_API_KEY = remoteConfig.getValue('xai_api_key').asString() || "";
            }).catch(err => console.error("Remote Config error:", err));
        }

        // ── Realtime Data ───────────────────────────────────────────────────────────
        function initRealtimeListener() {
            db.ref(`crm/${currentUser.uid}/deals`).on('value', snapshot => {
                deals = [];
                snapshot.forEach(child => {
                    deals.push({ id: child.key, ...child.val() });
                });
                renderAll();
            });
        }

        function renderAll() {
            updateDashboard();
            renderPipeline();
            renderContacts();
        }

        // ── Dashboard ───────────────────────────────────────────────────────────────
        function updateDashboard() {
            const total = deals.reduce((sum, d) => sum + (parseFloat(d.value)||0), 0);
            const won = deals.filter(d => d.stage === 'won').length;
            const open = deals.filter(d => !['won','lost'].includes(d.stage)).length;

            document.getElementById('statRevenue').textContent = currencyFmt.format(total).replace('ZAR', 'R');
            document.getElementById('statWon').textContent = won;
            document.getElementById('statOpen').textContent = open;

            const ctx = document.getElementById('revenueChart').getContext('2d');
            const counts = [
                deals.filter(d => d.stage === 'lead').length,
                deals.filter(d => d.stage === 'negotiation').length,
                deals.filter(d => d.stage === 'won').length,
                deals.filter(d => d.stage === 'lost').length
            ];

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Leads', 'Negotiation', 'Won', 'Lost'],
                    datasets: [{
                        label: 'Deals',
                        data: counts,
                        backgroundColor: ['#6366f1', '#f59e0b', '#10b981', '#ef4444'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        // ── Pipeline ────────────────────────────────────────────────────────────────
        function renderPipeline() {
            ['lead','negotiation','won','lost'].forEach(stage => {
                const col = document.getElementById(`col-${stage}`);
                const count = document.getElementById(`count-${stage}`);
                if (!col || !count) return;
                col.innerHTML = '';
                const filtered = deals.filter(d => d.stage === stage);
                count.textContent = filtered.length;

                filtered.forEach(deal => {
                    const card = document.createElement('div');
                    card.className = 'deal-card';
                    card.draggable = true;
                    card.ondragstart = e => drag(e, deal.id);
                    card.onclick = () => openDealModal(deal);
                    card.innerHTML = `
                        <div style="font-weight:500;">${deal.clientName || 'No name'}</div>
                        <div style="font-size:0.82rem;color:var(--text-sub);">${deal.company || '—'}</div>
                        <div class="deal-price">${currencyFmt.format(parseFloat(deal.value)||0).replace('ZAR','R')}</div>
                    `;
                    col.appendChild(card);
                });
            });
        }

        function allowDrop(e) { e.preventDefault(); }
        function drag(e, id) { e.dataTransfer.setData("text", id); }
        function drop(e, stage) {
            e.preventDefault();
            const id = e.dataTransfer.getData("text");
            if (id) {
                db.ref(`crm/${currentUser.uid}/deals/${id}`).update({
                    stage,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // ── Contacts Table ──────────────────────────────────────────────────────────
        function renderContacts() {
            const tbody = document.getElementById('contactsTableBody');
            tbody.innerHTML = '';

            if (deals.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-sub);">No deals yet — add your first one!</td></tr>`;
                return;
            }

            deals.forEach(deal => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:500">${deal.clientName || '—'}</td>
                    <td>${deal.company || '—'}</td>
                    <td>${currencyFmt.format(parseFloat(deal.value)||0).replace('ZAR','R')}</td>
                    <td><span class="status-badge status-${deal.stage}">${deal.stage.toUpperCase()}</span></td>
                    <td>
                        <button onclick="openDealModal('${deal.id}')" style="color:var(--primary);background:none;border:none;cursor:pointer;margin-right:8px;">
                            <span class="material-symbols-rounded">edit</span>
                        </button>
                        <button onclick="confirmDelete('${deal.id}')" style="color:var(--danger);background:none;border:none;cursor:pointer;">
                            <span class="material-symbols-rounded">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ── Deal Modal ──────────────────────────────────────────────────────────────
        function openDealModal(deal = null) {
            const modal = document.getElementById('dealModal');
            const title = document.getElementById('dealModalTitle');
            const form = document.getElementById('dealForm');
            const saveBtn = document.getElementById('saveDealBtn');

            form.reset();
            document.getElementById('aiOutput').style.display = 'none';
            document.querySelectorAll('.form-error').forEach(el => el.style.display = 'none');

            if (deal && typeof deal === 'object') {
                title.textContent = 'Edit Deal';
                document.getElementById('dealId').value = deal.id || '';
                document.getElementById('inpName').value = deal.clientName || '';
                document.getElementById('inpCompany').value = deal.company || '';
                document.getElementById('inpValue').value = deal.value || '';
                document.getElementById('inpStage').value = deal.stage || 'lead';
            } else if (typeof deal === 'string') {
                // Edit from contacts table by ID
                const found = deals.find(d => d.id === deal);
                if (found) openDealModal(found);
                return;
            } else {
                title.textContent = 'New Deal';
                document.getElementById('dealId').value = '';
                document.getElementById('inpStage').value = 'lead';
            }

            saveBtn.disabled = false;
            saveBtn.textContent = deal ? 'Update Deal' : 'Save Deal';
            modal.style.display = 'flex';
        }

        function closeDealModal() {
            document.getElementById('dealModal').style.display = 'none';
        }

        async function saveDeal(e) {
            e.preventDefault();

            const name = document.getElementById('inpName').value.trim();
            const value = document.getElementById('inpValue').value.trim();
            const errName = document.getElementById('errName');
            const errValue = document.getElementById('errValue');
            const saveBtn = document.getElementById('saveDealBtn');

            let hasError = false;
            errName.style.display = 'none';
            errValue.style.display = 'none';

            if (!name) {
                errName.style.display = 'block';
                hasError = true;
            }
            if (!value || isNaN(parseFloat(value)) || parseFloat(value) < 0) {
                errValue.style.display = 'block';
                hasError = true;
            }

            if (hasError) return;

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            const id = document.getElementById('dealId').value;
            const data = {
                clientName: name,
                company: document.getElementById('inpCompany').value.trim(),
                value: parseFloat(value),
                stage: document.getElementById('inpStage').value,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                if (id) {
                    await db.ref(`crm/${currentUser.uid}/deals/${id}`).update(data);
                    showAlert('Success', 'Deal updated successfully!', 'success');
                } else {
                    await db.ref(`crm/${currentUser.uid}/deals`).push(data);
                    showAlert('Success', 'New deal added successfully!', 'success');
                }
                closeDealModal();
            } catch (err) {
                console.error(err);
                showAlert('Error', 'Failed to save deal. Please try again.', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = id ? 'Update Deal' : 'Save Deal';
            }
        }

        // ── Delete Confirmation ─────────────────────────────────────────────────────
        function confirmDelete(id) {
            showConfirm(
                'Delete Deal',
                'Are you sure you want to delete this deal? This action cannot be undone.',
                () => {
                    db.ref(`crm/${currentUser.uid}/deals/${id}`).remove()
                        .then(() => showAlert('Success', 'Deal deleted successfully!', 'success'))
                        .catch(err => {
                            console.error(err);
                            showAlert('Error', 'Failed to delete deal.', 'error');
                        });
                }
            );
        }

        // ── Custom Alert / Confirm System ───────────────────────────────────────────
        function showAlert(title, message, type = 'info') {
            const modal = document.getElementById('alertModal');
            const titleEl = document.getElementById('alertTitle');
            const msgEl = document.getElementById('alertMessage');
            const actionsEl = document.getElementById('alertActions');

            titleEl.textContent = title;
            msgEl.textContent = message;

            if (type === 'success') titleEl.style.color = 'var(--success)';
            else if (type === 'error') titleEl.style.color = 'var(--danger)';
            else titleEl.style.color = 'var(--text-main)';

            actionsEl.innerHTML = `
                <button class="btn btn-primary" onclick="closeAlertModal()">OK</button>
            `;

            modal.style.display = 'flex';
        }

        function showConfirm(title, message, onConfirm) {
            const modal = document.getElementById('alertModal');
            const titleEl = document.getElementById('alertTitle');
            const msgEl = document.getElementById('alertMessage');
            const actionsEl = document.getElementById('alertActions');

            titleEl.textContent = title;
            msgEl.textContent = message;
            titleEl.style.color = 'var(--danger)';

            actionsEl.innerHTML = `
                <button class="btn btn-outline" onclick="closeAlertModal()">Cancel</button>
                <button class="btn btn-danger" onclick="closeAlertModal(); ${onConfirm.toString().replace(/\n/g, '')}()">Delete</button>
            `;

            modal.style.display = 'flex';
        }

        function closeAlertModal() {
            document.getElementById('alertModal').style.display = 'none';
        }

        // ── Navigation ──────────────────────────────────────────────────────────────
        function nav(view, el) {
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            el.classList.add('active');
            document.getElementById('pageTitle').textContent = {
                dashboard: 'Dashboard',
                pipeline: 'Sales Pipeline',
                contacts: 'Client List'
            }[view] || 'Dashboard';

            if (window.innerWidth <= 768) toggleSidebar();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', e => {
                if (e.target === overlay) {
                    overlay.style.display = 'none';
                }
            });
        });

        // ── AI Functions ────────────────────────────────────────────────────────────
        async function generateContextEmail() {
            if (!XAI_API_KEY) {
                showAlert('Error', 'AI configuration not loaded yet.', 'error');
                return;
            }

            const name = document.getElementById('inpName').value.trim();
            const company = document.getElementById('inpCompany').value.trim();
            const stage = document.getElementById('inpStage').value;
            const output = document.getElementById('aiOutput');

            if (!name) {
                showAlert('Error', 'Please enter client name first.', 'error');
                return;
            }

            output.style.display = 'block';
            output.value = "Generating email draft...";

            let contextPrompt = "";
            if (stage === 'lead') contextPrompt = "an introductory email offering our services";
            else if (stage === 'negotiation') contextPrompt = "a professional follow-up email regarding our proposal and pricing in South African Rand";
            else if (stage === 'won') contextPrompt = "a thank-you email for closing the deal";
            else contextPrompt = "a polite re-engagement email";

            const prompt = `Write ${contextPrompt} to ${name} at ${company || "their company"}. Keep it professional, concise, warm, and use South African English spelling. Sender name: Vynix Lingua.`;

            await callAI(prompt, (text) => {
                output.value = text;
            });
        }

        function toggleAIWindow() {
            const win = document.getElementById('aiWindow');
            win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        }

        async function sendGlobalAI() {
            const input = document.getElementById('aiGlobalInput');
            const body = document.getElementById('aiChatBody');
            const txt = input.value.trim();
            if (!txt) return;

            body.innerHTML += `<div class="ai-msg user">${txt}</div>`;
            input.value = '';
            body.scrollTop = body.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            body.innerHTML += `<div id="${loadingId}" class="ai-msg bot">Thinking...</div>`;
            body.scrollTop = body.scrollHeight;

            const totalValue = deals.reduce((sum, d) => sum + (parseFloat(d.value)||0), 0);
            const context = `Current CRM stats: ${deals.length} total deals | Total pipeline value: R${totalValue.toLocaleString('en-ZA')} | Won deals: ${deals.filter(d=>d.stage==='won').length}`;

            const prompt = `${context}\n\nUser question: ${txt}\nAnswer concisely and helpfully.`;

            await callAI(prompt, (text) => {
                document.getElementById(loadingId).innerText = text;
                body.scrollTop = body.scrollHeight;
            });
        }

        async function callAI(prompt, callback) {
            try {
                const res = await fetch("https://api.x.ai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${XAI_API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "grok-beta",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.7,
                        max_tokens: 800
                    })
                });

                if (!res.ok) throw new Error("API error");
                const json = await res.json();
                callback(json.choices[0].message.content.trim());
            } catch (err) {
                console.error(err);
                callback("Sorry, couldn't connect to the AI assistant right now.");
            }
        }
    </script>
</body>
</html>
