<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireCRM - Business Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">

    <div id="login-screen" class="flex items-center justify-center h-screen">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h1 class="text-2xl font-bold mb-6 text-blue-600 text-center">FireCRM Login</h1>
            <input type="email" id="email" placeholder="Email" class="w-full p-3 mb-4 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="password" placeholder="Password" class="w-full p-3 mb-4 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="login()" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 transition">Sign In / Sign Up</button>
            <p id="login-msg" class="text-red-500 text-sm mt-4 text-center"></p>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen">
        <nav class="bg-white shadow px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800"><i class="fas fa-users text-blue-600 mr-2"></i>FireCRM</h1>
            <button onclick="logout()" class="text-gray-600 hover:text-red-500 font-medium">Logout</button>
        </nav>

        <div class="container mx-auto p-6">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded shadow border-l-4 border-blue-500">
                    <h3 class="text-gray-500 text-sm uppercase">Total Leads</h3>
                    <p class="text-2xl font-bold" id="total-count">0</p>
                </div>
                <div class="bg-white p-6 rounded shadow border-l-4 border-green-500">
                    <h3 class="text-gray-500 text-sm uppercase">Active Deals</h3>
                    <p class="text-2xl font-bold" id="active-count">0</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded shadow mb-8">
                <h2 class="text-lg font-bold mb-4">Add New Customer</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="leadName" placeholder="Name" class="p-2 border rounded">
                    <input type="text" id="leadCompany" placeholder="Company" class="p-2 border rounded">
                    <select id="leadStatus" class="p-2 border rounded bg-white">
                        <option value="New">New Lead</option>
                        <option value="Contacted">Contacted</option>
                        <option value="Closed">Closed Deal</option>
                    </select>
                    <button onclick="addLead()" class="bg-green-600 text-white p-2 rounded hover:bg-green-700"><i class="fas fa-plus mr-1"></i> Add Lead</button>
                </div>
            </div>

            <div class="bg-white rounded shadow overflow-hidden">
                <div class="px-6 py-4 border-b">
                    <h2 class="font-bold text-gray-700">Customer Database</h2>
                </div>
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 text-sm uppercase">
                            <th class="p-4 border-b">Name</th>
                            <th class="p-4 border-b">Company</th>
                            <th class="p-4 border-b">Status</th>
                            <th class="p-4 border-b text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leads-table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. Import Firebase SDKs (using version 9 modular syntax)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // 2. YOUR CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            projectId: "fire-b-a8878",
            databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- AUTHENTICATION LOGIC ---

        // Check login state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadLeads(); // Load data when logged in
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        });

        // Login Function (Exposed to window for HTML onclick)
        window.login = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                // If user not found, try to create account (Quick dev hack)
                if(error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                     try {
                        await createUserWithEmailAndPassword(auth, email, password);
                        alert("Account created! You are now logged in.");
                     } catch (createError) {
                        msg.innerText = createError.message;
                     }
                } else {
                    msg.innerText = error.message;
                }
            }
        };

        window.logout = () => signOut(auth);

        // --- DATABASE LOGIC (CRM) ---

        // Add Lead
        window.addLead = () => {
            const name = document.getElementById('leadName').value;
            const company = document.getElementById('leadCompany').value;
            const status = document.getElementById('leadStatus').value;

            if (!name) return alert("Please enter a name");

            const leadsRef = ref(db, 'leads');
            push(leadsRef, {
                name: name,
                company: company,
                status: status,
                timestamp: Date.now()
            });

            // Clear inputs
            document.getElementById('leadName').value = '';
            document.getElementById('leadCompany').value = '';
        };

        // Load and Listen for Leads
        function loadLeads() {
            const leadsRef = ref(db, 'leads');
            onValue(leadsRef, (snapshot) => {
                const tableBody = document.getElementById('leads-table-body');
                tableBody.innerHTML = ""; // Clear current list
                let total = 0;
                let active = 0;

                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        const lead = data[key];
                        total++;
                        if(lead.status !== "Closed") active++;

                        // Color badge based on status
                        let badgeColor = lead.status === 'New' ? 'bg-blue-100 text-blue-800' : 
                                         lead.status === 'Closed' ? 'bg-gray-100 text-gray-800' : 'bg-yellow-100 text-yellow-800';

                        const row = `
                            <tr class="hover:bg-gray-50 border-b last:border-0">
                                <td class="p-4 font-medium">${lead.name}</td>
                                <td class="p-4 text-gray-500">${lead.company}</td>
                                <td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${badgeColor}">${lead.status}</span></td>
                                <td class="p-4 text-right">
                                    <button onclick="deleteLead('${key}')" class="text-red-500 hover:text-red-700 text-sm">Delete</button>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                }
                
                // Update stats
                document.getElementById('total-count').innerText = total;
                document.getElementById('active-count').innerText = active;
            });
        }

        // Delete Lead
        window.deleteLead = (id) => {
            if(confirm('Are you sure you want to remove this lead?')) {
                const leadRef = ref(db, `leads/${id}`);
                remove(leadRef);
            }
        };
    </script>
</body>
</html>
